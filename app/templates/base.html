<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Jobsta{% endblock %}</title>
    <script>
        // Load theme IMMEDIATELY to prevent FOUC
        (function(){
            const root = document.documentElement;
            const storedMode = localStorage.getItem('theme') || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            if(storedMode === 'dark') {
                root.classList.add('dark');
            } else {
                root.classList.remove('dark');
            }
        })();
    </script>
    <link href="{{ url_for('static', filename='css/main.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/theme.css') }}" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script>
        // Theme API stubs
        if (!window.setThemeColor) window.setThemeColor = function(hex){};
        if (!window.setThemeMode) window.setThemeMode = function(mode){};
        if (!window.toggleTheme) window.toggleTheme = function(){};
    </script>
</head>
<body class="min-h-screen bg-surface text-copy" x-data="{ open: false }" :class="{ 'overflow-hidden': open }">
    {% set form_input_classes = "mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-blue-500 focus:border-blue-500" %}
    {% block nav %}
    <a class="sr-only focus:not-sr-only" href="#main">Skip to content</a>
    
    <nav class="site-nav shadow sticky top-0 z-50 bg-surface" role="navigation" aria-label="Main navigation">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between" style="height:var(--header-h,3.5rem)">
                
                <div class="flex items-center space-x-3">
                    {% if current_user and '/admin' not in request.path %}
                    <a href="{{ url_for('users.dashboard') }}" class="text-lg font-semibold leading-none text-inherit no-underline">Jobsta</a>
                    {% elif current_user and '/admin' in request.path %}
                    <a href="{{ url_for('admin.index') }}" class="text-lg font-semibold leading-none text-inherit no-underline">Jobsta</a>
                    {% else %}
                    <a href="{{ url_for('index') }}" class="text-lg font-semibold leading-none text-inherit no-underline">Jobsta</a>
                    {% endif %}
                    {% if (current_user and current_user.role == 'admin') or admin_root %}
                    <span class="admin-badge">Admin</span>
                    {% endif %}
                </div>

                <div class="hidden md:flex items-center space-x-4 nav-links" role="menubar">
                    {% if current_user and '/admin' not in request.path %}
                    <a href="{{ url_for('users.dashboard') }}" {% if request.endpoint == 'users.dashboard' %}aria-current="page"{% endif %} class="px-3 py-2 rounded-md text-sm font-medium">Home</a>
                    <a href="{{ url_for('users.jobs') }}" {% if request.endpoint == 'users.jobs' %}aria-current="page"{% endif %} class="px-3 py-2 rounded-md text-sm font-medium">Jobs</a>
                    <a href="{{ url_for('users.applications') }}" {% if request.endpoint == 'users.applications' %}aria-current="page"{% endif %} class="px-3 py-2 rounded-md text-sm font-medium">Applications</a>
                    <a href="{{ url_for('users.notifications') }}" {% if request.endpoint == 'users.notifications' %}aria-current="page"{% endif %} class="px-3 py-2 rounded-md text-sm font-medium">Notifications</a>
                    {% endif %}
                </div>

                <div class="flex items-center space-x-3">
                    {% if current_user and '/admin' in request.path %}
                        <div class="hidden md:flex items-center space-x-2">
                            <div class="text-sm font-medium">{{ admin_name or 'root' }}</div>
                            <a href="{{ url_for('admin.logout') }}" class="text-sm text-error">Logout</a>
                        </div>
                    {% elif current_user %}
                        <div x-data="{openUser:false}" >
                            {% if not is_mobile %}
                            <button @click="openUser = !openUser" :aria-expanded="openUser.toString()" class="focus-visible:shadow-outline avatar" title="{{ current_user.name or current_user.email }}">
                                {{ (current_user.name or current_user.email)[0]|upper }}
                            </button>
                            {% endif %}
                            <div x-show="openUser" x-transition @click.away="openUser=false" class="user-dropdown origin-top-right absolute right-0 mt-2 w-52 rounded-md shadow-lg z-50 bg-surface border border-muted-border">
                                <div class="p-3 text-sm">
                                    <div class="flex items-center gap-2 mb-2 pb-2 border-b border-muted-border">
                                        <div>
                                            <div class="font-medium">{{ current_user.name or current_user.email }}</div>
                                            <div class="text-xs text-muted">{{ current_user.email }}</div>
                                        </div>
                                    </div>
                                        <div class="mt-2" style="backdrop-filter: blur(10px);">
                                        <a href="{{ url_for('users.settings') }}" class="dropdown-item block px-2 py-1 rounded">Settings</a>
                                        <a href="{{ url_for('users.recommendations') }}" class="dropdown-item block px-2 py-1 rounded">Recommendations</a>
                                        <!-- theme toggle removed from dropdown; single header toggle is used -->
                                        <hr class="my-2 border-muted-border" />
                                        <a href="{{ url_for('auth.logout') }}" class="dropdown-item text-error block px-2 py-1 rounded">Logout</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="hidden md:flex items-center space-x-2">
                            <a href="{{ url_for('auth.register') }}" class="px-3 py-2 rounded-md text-sm font-medium">Register</a>
                            <a href="{{ url_for('auth.login') }}" class="px-3 py-2 rounded-md text-sm font-medium border border-primary text-primary">Login</a>
                        </div>
                    {% endif %}

                    <button @click="window.toggleTheme()" aria-label="Toggle theme" class="theme-toggle p-2 rounded inline-flex items-center justify-center mr-2" style="min-width:40px;min-height:40px;">
                        <svg class="h-6 w-6 inline-block dark:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v2m0 14v2m9-9h-2M5 12H3m15.364-6.364l-1.414 1.414M7.05 16.95l-1.414 1.414M16.95 16.95l1.414 1.414M6.343 6.343L4.93 4.93M12 8a4 4 0 100 8 4 4 0 000-8z" />
                        </svg>
                        <svg class="h-6 w-6 hidden dark:inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />
                        </svg>
                    </button>
                    <button @click="open = !open"
                            class="relative md:hidden w-10 h-10 flex items-center justify-center"
                            aria-label="Toggle menu">

                        <!-- Hamburger -->
                        <svg x-cloak x-show="!open" x-transition
                            class="h-6 w-6"
                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 12h16M4 18h16" />
                        </svg>

                        <!-- X icon -->
                        <svg x-cloak x-show="open" x-transition
                            class="absolute inset-0 m-auto h-6 w-6"
                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>

                    </button>


                </div>
            </div>
        </div>

        <div x-show="open" x-transition.opacity class="fixed inset-0 z-[40] md:hidden">
            <div x-show="open" x-transition.opacity class="absolute inset-0 bg-black/50 backdrop-blur-md"></div>

            <div x-show="open"
                x-transition:enter="transform transition ease-in-out duration-300"
                x-transition:enter-start="translate-x-full"
                x-transition:enter-end="translate-x-0"
                x-transition:leave="transform transition ease-in-out duration-300"
                x-transition:leave-start="translate-x-0"
                x-transition:leave-end="translate-x-full"
                class="absolute right-0 top-0 h-full w-72 max-w-[85%] bg-surface shadow-2xl flex flex-col z-[100]">

                <!-- floating panel (right-side) -->

                <div class="space-y-6 text-lg font-medium" style="backdrop-filter: blur(10px);" height="100%" width="100%">
                    
                    {% if current_user and not (is_admin or admin_root) %}
                        <div class="flex items-center gap-3 px-3 py-3 bg-muted/10 rounded-lg mb-4">
                            <div class="avatar shrink-0">{{ (current_user.name or current_user.email)[0]|upper }}</div>
                            <div class="truncate">
                                <div class="font-medium truncate">{{ current_user.name or current_user.email }}</div>
                                <div class="text-xs text-muted truncate">{{ current_user.email }}</div>
                            </div>
                        </div>
                        <a href="{{ url_for('users.dashboard') }}" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-muted/10">Home</a>
                        <a href="{{ url_for('users.jobs') }}" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-muted/10">Jobs</a>
                        <a href="{{ url_for('users.applications') }}" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-muted/10">Applications</a>
                        <a href="{{ url_for('users.notifications') }}" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-muted/10">Notifications</a>
                        <a href="{{ url_for('users.recommendations') }}" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-muted/10">Recommendations</a>
                        <div class="border-t border-muted-border pt-4 mt-4">
                            <a href="{{ url_for('users.settings') }}" class="block px-3 py-2 rounded-md text-base font-medium">Settings</a>
                            <a href="{{ url_for('users.recommendations') }}" class="block px-3 py-2 rounded-md text-base font-medium">Recommendations</a>
                            <!-- removed duplicate mobile theme toggle -->
                            <a href="{{ url_for('auth.logout') }}" class="block px-3 py-2 rounded-md text-base font-medium text-error">Logout</a>
                        </div>
                    {% elif admin_root %}
                        <div class="px-3 py-3 border-b border-muted-border mb-2">
                            <div class="font-medium">{{ admin_name or 'root' }} (Admin)</div>
                        </div>
                        <!-- removed duplicate admin theme toggle -->
                        <a href="{{ url_for('admin.logout') }}" class="block px-3 py-2 rounded-md text-base font-medium text-error">Logout</a>
                    {% else %}
                        <a href="{{ url_for('auth.login') }}" class="block px-3 py-2 rounded-md text-base font-medium">Login</a>
                        <a href="{{ url_for('auth.register') }}" class="block px-3 py-2 rounded-md text-base font-medium">Register</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>
    {% endblock %}

    <main id="main" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="bg-success/10 border border-success/20 text-success px-4 py-3 rounded mb-6">
            {% for message in messages %}
            <p class="text-sm font-medium">{{ message }}</p>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}
        
        {% block content %}{% endblock %}
    </main>

    <script>
        (function(){
            const root = document.documentElement;

            function applyThemeMode(mode){
                if(mode === 'dark') root.classList.add('dark'); else root.classList.remove('dark');
            }

            function hexToHsl(hex){
                hex = hex.replace('#','');
                if(hex.length === 3) hex = hex.split('').map(h=>h+h).join('');
                const r = parseInt(hex.substring(0,2),16)/255;
                const g = parseInt(hex.substring(2,4),16)/255;
                const b = parseInt(hex.substring(4,6),16)/255;
                const max = Math.max(r,g,b), min = Math.min(r,g,b);
                let h=0, s=0, l=(max+min)/2;
                if(max !== min){
                    const d = max - min;
                    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                    switch(max){
                        case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                        case g: h = (b - r) / d + 2; break;
                        case b: h = (r - g) / d + 4; break;
                    }
                    h = Math.round(h * 60); s = Math.round(s * 100); l = Math.round(l * 100);
                }
                return {h, s, l};
            }

            function setThemeColor(hex){
                try{
                    const hsl = hexToHsl(hex);
                    root.style.setProperty('--base-h', hsl.h);
                    root.style.setProperty('--base-s', hsl.s + '%');
                    root.style.setProperty('--base-l', hsl.l + '%');
                    localStorage.setItem('theme_color', hex);
                }catch(e){}
            }

            const storedMode = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            const storedColor = localStorage.getItem('theme_color') || '#d4a574';
            
            applyThemeMode(storedMode);
            setThemeColor(storedColor);

            window.toggleTheme = function(){
                const current = root.classList.contains('dark') ? 'dark' : 'light';
                const next = current === 'dark' ? 'light' : 'dark';
                localStorage.setItem('theme', next);
                applyThemeMode(next);
            }

            window.setThemeColor = setThemeColor;
            window.setThemeMode = function(mode){
                localStorage.setItem('theme', mode);
                applyThemeMode(mode);
            };
        })();
    </script>
</body>
</html>